---
title: "Drug Group Cosinor 'Your Measured Compound' Functionalized"
output: html_document
date: "Your Date"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# List of packages to check and install
packages <- c("base", "cosinor", "cosinor2", "ggplot2", "grid", "gridExtra",
        "here", "magrittr", "minpack.lm", "readxl", "stats", "tidyr", "dplyr")

# Function to check and install missing packages
missing_packages <- packages[!packages %in% installed.packages()[, "Package"]]
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

# Load all packages
lapply(packages, library, character.only = TRUE)

library(cosinor)
library(ggplot2)
library(gridExtra)
library(here)
library(minpack.lm)
library(readxl)
library(tidyr)
library(dplyr)
```


```{r}
# Sourcing Custom-Made Functions
source("../outlier_detection.R")
source("../filter_outliers.R")
source("../extract_cosinor_clock.R")
source("../zero_amp.R")
source("../plot_cosinor_clock.R")
source("../create_combined_pdf.R")
source("../export_excel.R")
```


### Reading, Converting, Analyzing and Plotting 'Your Measured Compound' 
### Administered Rats 
#### Reading in 'Your Measured Compound' Administered Rat Data for 
#### LD and rLEN
```{r}
# Reading Clock Bmal1 Administered Rats
readxl::read_excel(path ="../Your Data File.xlsx",
                   sheet = "Your Sheet Name",
                    range ="Your Range") ->  Circadian_'Your Abbrev Compound Name'

 Circadian_'Your Abbrev Compound Name' %>%
  select(`Animal ID`,`Time point`, `Group`, `Normalized fold change`) %>%
  rename("ID" = `Animal ID`, "Time" = `Time point`,
        "Change" = `Normalized fold change`)->  Circadian_'Your Abbrev Compound Name'


# Check if 'Normalized fold change' is character and needs parsing
if (is.character( Circadian_'Your Abbrev Compound Name'$Change)) {
   Circadian_'Your Abbrev Compound Name' <-  Circadian_'Your Abbrev Compound Name' %>%
    mutate(Change = parse_number(Change))
}

# Separating LD data and pivoting
 Circadian_'Your Abbrev Compound Name'_LD <-  Circadian_'Your Abbrev Compound Name' %>%
  filter(grepl("LD", Group)) %>%
  mutate(
    Time = recode(Time,
    "ZT0" = "0", "ZT6" = "6", "ZT12" = "12", "ZT18" = "18", "ZT24" = "24")
  ) %>%
  pivot_wider(
    id_cols = ID,
    names_from = Time,
    values_from = Change) %>%
  select(-c(ID))
if (!"24" %in% colnames( Circadian_'Your Abbrev Compound Name'_LD)) {
   LD_Circadian_'Your Abbrev Compound Name'_Filter <-  Circadian_'Your Abbrev Compound Name'_LD %>%
    mutate(`24` = `0`)}

# Separating rLEN data and pivoting    
 Circadian_'Your Abbrev Compound Name'_rLEN <-  Circadian_'Your Abbrev Compound Name' %>%
  filter(grepl("rLEN", Group)) %>%
  mutate(
    Time = recode(Time,
    "ZT0" = "0", "ZT6" = "6", "ZT12" = "12", "ZT18" = "18", "ZT24" = "24")
  ) %>%
  pivot_wider(
    id_cols = ID,
    names_from = Time,
    values_from = Change)%>%
  select(-c(ID))
if (!"24" %in% colnames( Circadian_'Your Abbrev Compound Name'_rLEN)) {
   rLEN_Circadian_'Your Abbrev Compound Name'_Filter <-  Circadian_'Your Abbrev Compound Name'_rLEN %>%
    mutate(`24` = `0`)}
```


#### Converting Data into Usable Format for Extracting VOIs and Plotting
```{r}
# Data Conversion to get Individual Points for LD 'Your Measured Compound' 
# Rat Model
## X value is Zeitgeber time,  Y value is # of Fold Changes

# Loads Initial Dataset for LD 'Your Measured Compound' Rats and 
# Removes Outliers
#outlier_detection(Circadian_'Your Abbrev Compound Name'_LD) -> out_res_LD'Your Abbrev Tag'
#filter_outliers(Circadian_'Your Abbrev Compound Name'_LD, 
#                out_res_LD'Your Abbrev Tag') ->  LD_Circadian_'Your Abbrev Compound Name'_Filter

# Performs Data Carpentry on Filtered LD 'Your Abbrev Tag' Dataset and Removes 'NA's,
## filters out ZT of 24
LD_Circadian_'Your Abbrev Compound Name'_Filter %>%
  pivot_longer(cols = c(`0`,`6`,`12`, `18`, `24`), names_to = "ZT", 
               values_to = "Concentration(mg)") %>%
  drop_na(`Concentration(mg)`) %>%
  mutate(ZT = as.numeric(ZT)) %>%
  arrange(ZT) -> LD_Circadian_'Your Abbrev Compound Name'_Filter
LD_Circadian_'Your Abbrev Compound Name'_Filter %>%
  # Filter out ZT of 24
  filter(ZT != 24)  -> LD_Circadian_'Your Abbrev Compound Name'_data

# Creating Cosinor Model for LD 'Your Abbrev Tag' Rat Plots
cosinor.lm(`Concentration(mg)` ~ time(ZT), period = 24,
           data = LD_Circadian_'Your Abbrev Compound Name'_Filter) -> cosMod_LD_'Your Abbrev Tag'
# Creating Cosinor Model for LD 'Your Abbrev Tag' Rat Data Analysis
cosinor.lm(`Concentration(mg)` ~ time(ZT), period = 24,
           data = LD_Circadian_'Your Abbrev Compound Name'_data) -> cosMod_LD_'Your Abbrev Tag'_data
```

```{r}
# Data Conversion to get Individual Points for rLEN 'Your Measured Compound' 
# Rat Model X value is Zeitgeber time,  Y value is # of Fold Changes

# Loads Initial Dataset for rLEN 'Your Measured Compound' Rats and Removes Outliers
outlier_detection(Circadian_'Your Abbrev Compound Name'_rLEN) -> out_res_rLEN'Your Abbrev Tag'
filter_outliers(Circadian_'Your Abbrev Compound Name'_rLEN, 
                out_res_rLEN'Your Abbrev Tag') ->  rLEN_Circadian_'Your Abbrev Compound Name'_Filter

# Performs Data Carpentry on Filtered LD 'Your Abbrev Tag' Dataset and Removes 'NA's
rLEN_Circadian_'Your Abbrev Compound Name'_Filter %>%
  pivot_longer(cols = c(`0`,`6`,`12`, `18`, `24`), names_to = "ZT", 
               values_to = "Concentration(mg)") %>%
  drop_na(`Concentration(mg)`) %>%
  mutate(ZT = as.numeric(ZT)) %>%
  arrange(ZT) -> rLEN_Circadian_'Your Abbrev Compound Name'_Filter
rLEN_Circadian_'Your Abbrev Compound Name'_Filter %>%
  # Filter out ZT of 24
  filter(ZT != 24)  -> rLEN_Circadian_'Your Abbrev Compound Name'_data

# Creating Cosinor Model for LD 'Your Abbrev Tag' Rat Plots
cosinor.lm(`Concentration(mg)` ~ time(ZT), period = 24,
           data = rLEN_Circadian_'Your Abbrev Compound Name'_Filter) -> cosMod_rLEN_'Your Abbrev Tag'
# Creating Cosinor Model for LD 'Your Abbrev Tag' Rat Plot Data Analysis
cosinor.lm(`Concentration(mg)` ~ time(ZT), period = 24,
           data = rLEN_Circadian_'Your Abbrev Compound Name'_data) -> cosMod_rLEN_'Your Abbrev Tag'_data
```


#### Calculating the Y-limits for Plots of Cosinor Fit
```{r}
# Finding the max Y-value Across Both Datsets in Order to Set Y-limits of 
# Future Plot
max(rLEN_Circadian_'Your Abbrev Compound Name'_Filter$`Fold_Changes`, 
    LD_Circadian_'Your Abbrev Compound Name'_Filter$`Fold_Changes`) -> 'Your Abbrev Tag'_max
# Calculate y_peak based on 'Your Abbrev Tag'_max
if ('Your Abbrev Tag'_max < 3) {
  y_peak <- ceiling('Your Abbrev Tag'_max / 0.25) * 0.25 
  } else {
  y_peak <- ceiling('Your Abbrev Tag'_max / 5) * 5}
```


#### Creating Plots of Original Data with Cosinor Fit Overlayed for Rat Models
```{r}
# Creating Individual Plots of Rat Datasets w/ Cosinor Fits
## Loads Function plot_cosinor_clock Into Global Environment, Which Takes cosMod 
## Model, Original Dataset, Plot Title and Desired x-breaks (currently set for
## Zetigeber Time, to see how to change to regular time see function notes) and
## Generates Plot of Original Data with Overlayed Cosinor Fit Model

# Creating Plot for LD 'Your Abbrev Tag' Rat Model
plot_cosinor_clock(cosMod_LD_'Your Abbrev Tag', LD_Circadian_'Your Abbrev Compound Name'_Filter, 
             "LD 'Your Measured Compound'", "LD",
             x_breaks = seq(0, 24, by = 6)) -> mod_plot_LD_'Your Abbrev Tag'


# Creating Plot for rLEN 'Your Abbrev Tag' Rat Model
plot_cosinor_clock(cosMod_rLEN_'Your Abbrev Tag', rLEN_Circadian_'Your Abbrev Compound Name'_Filter, 
             "rLEN 'Your Measured Compound'", "rLEN",
             x_breaks = seq(0, 24, by = 6)) -> mod_plot_rLEN_'Your Abbrev Tag'
```


#### Performing Cosinor Analysis for Rat Datasets
```{r}
# Creating Table of Data VOIs for LD 'Your Measured Compound' Rat Model
## Produces Table of Pertinent Values (Mesor, Amplitude, Acrophase, Bathyphase)
## and Converts Table into Graphical Object for Figure Creation
extract_cosinor_clock(cosMod_LD_'Your Abbrev Tag'_data, LD_Circadian_'Your Abbrev Compound Name'_data,
                "LD") -> LD_extract_output
LD_'Your Abbrev Tag'_Results_table <- LD_extract_output$results_table
LD_'Your Abbrev Tag'_Results_grob <- LD_extract_output$results_grob


# Creating Table of Data VOIs for rLEN 'Your Measured Compound' Rat Model
## Produces Table of Pertinent Values (Mesor, Amplitude, Acrophase, Bathyphase)
## and Converts Table into Graphical Object for Figure Creation
extract_cosinor_clock(cosMod_rLEN_'Your Abbrev Tag'_data, rLEN_Circadian_'Your Abbrev Compound Name'_data,
                "rLEN") -> rLEN_extract_output
rLEN_'Your Abbrev Tag'_Results_table <- rLEN_extract_output$results_table
rLEN_'Your Abbrev Tag'_Results_grob <- rLEN_extract_output$results_grob
```


#### Performing Zero Amplitude Test Analysis on Rat Models
```{r}
# Zero-Amplitude Analysis of Cosinor Fit
## Creating Table of Zero Amplitude VOIs for LD 'Your Measured Compound' Rat Model

# Produces Table of Pertinent Values (df1, df2, f-value, p-value) and Converts 
# Table into Graphical Object for Figure Creation
zero_amp(cosMod_LD_'Your Abbrev Tag'_data, "LD") -> LD_zero_output
LD_'Your Abbrev Tag'_amp_test_Results <- LD_zero_output$results_table
LD_'Your Abbrev Tag'_amp_test_grob <- LD_zero_output$results_grob



# Produces Table of Pertinent Values (df1, df2, f-value, p-value) and Converts 
# Table into Graphical Object for Figure Creation
zero_amp(cosMod_rLEN_'Your Abbrev Tag'_data, "rLEN") -> rLEN_zero_output
rLEN_'Your Abbrev Tag'_amp_test_Results <- rLEN_zero_output$results_table
rLEN_'Your Abbrev Tag'_amp_test_grob <- rLEN_zero_output$results_grob
```


#### Creating Side-by-Side Plot Comparison of Cosinor Fit Models for LD and 
#### rLEN Rat Models
```{r, fig.width= 15}
# Set the working directory to the folder where you want to save the plot
plot_dir <- here("Combined Plots")
# Create the directory if it does not exist
if (!dir.exists(plot_dir)) dir.create(plot_dir)  

# Save the plot as PDF in the specified directory
pdf(file.path(plot_dir, "combined_'Your Abbrev Tag'_plots.pdf"), width=15, height=6)
grid.arrange(mod_plot_LD_'Your Abbrev Tag', mod_plot_rLEN_'Your Abbrev Tag', ncol = 2)
dev.off()
```


#### Creating Side-by-Side Table Comparisons of Cosinor Analysis and Zero
#### Amplitude Analysis VOIs
```{r}
# Set the working directory to the folder where you want to save the tables
table_dir <- here("Combined Tables")
# Create the directory if it does not exist
if (!dir.exists(table_dir)) dir.create(table_dir)  

headers <- c("Cosinor Parameters", "Zero Amp Parameters")
tables <- list(LD_'Your Abbrev Tag'_Results_grob, LD_'Your Abbrev Tag'_amp_test_grob, 
               rLEN_'Your Abbrev Tag'_Results_grob, rLEN_'Your Abbrev Tag'_amp_test_grob, NULL, NULL)
title_text <- "Comparison of 'Your Measured Compound' LD and rLEN Circadian Disruption Values"
output_file <- file.path(table_dir, "combined_'Your Abbrev Tag'_tables.pdf")
fig_width <- 7.5
fig_height <- 10
create_combined_pdf(headers, tables, title_text, output_file, fig_width, fig_height)
```


#### Exporting all Created Table Figures to Excel for Ease of
#### Data Copying/Compiling
```{r}
# Creating File Marker for Table Figure Identification in Function Code
file_abbrev <- "'Your Abbrev Tag'"
# Exporting Table Statistics to Excel Sheets
export_excel(file_abbrev)
```


#### Generation of Pseudo-Rayleigh Plots
```{r}
#### Creating a Combined Pseudo-Rayleigh Plot for Group Rhythm Visualization
# --- Data Extraction ---
# Extract LD 'Your Measured Compound' ('Your Abbrev Tag') data
LD_'Your Abbrev Tag'_acrophase <- LD_'Your Abbrev Tag'_Results_table$Values[LD_'Your Abbrev Tag'_Results_table$Parameter == "LD Acrophase (Hrs)"]
LD_'Your Abbrev Tag'_amplitude <- LD_'Your Abbrev Tag'_Results_table$Values[LD_'Your Abbrev Tag'_Results_table$Parameter == "LD Amplitude"]

# Extract rLEN 'Your Measured Compound' ('Your Abbrev Tag') data
rLEN_'Your Abbrev Tag'_acrophase <- rLEN_'Your Abbrev Tag'_Results_table$Values[rLEN_'Your Abbrev Tag'_Results_table$Parameter == "rLEN Acrophase (Hrs)"]
rLEN_'Your Abbrev Tag'_amplitude <- rLEN_'Your Abbrev Tag'_Results_table$Values[rLEN_'Your Abbrev Tag'_Results_table$Parameter == "rLEN Amplitude"]

# --- Data Preparation for Combined Plot ---
# Create data frames for each condition
LD_'Your Abbrev Tag'_vector_data <- data.frame(
  Condition = "LD",
  acrophase = LD_'Your Abbrev Tag'_acrophase,
  amplitude = LD_'Your Abbrev Tag'_amplitude
)

rLEN_'Your Abbrev Tag'_vector_data <- data.frame(
  Condition = "rLEN",
  acrophase = rLEN_'Your Abbrev Tag'_acrophase,
  amplitude = rLEN_'Your Abbrev Tag'_amplitude
)

# Combine the two data frames into a single one
combined_'Your Abbrev Tag'_vector_data <- rbind(LD_'Your Abbrev Tag'_vector_data, rLEN_'Your Abbrev Tag'_vector_data) %>%
  arrange(desc(amplitude))


# --- 1. Create the Main Plot ---
max_amplitude <- max(combined_'Your Abbrev Tag'_vector_data$amplitude, na.rm = TRUE)

# maximum radius
r_max <- max_amplitude * 1.5  

# Function to generate wedge polygons for polar coordinates
make_wedge <- function(start, end, r, n_points = 200) {
  # Generate angles (in hours) for the arc, including start and end
  theta <- seq(start, end, length.out = n_points + 2)  # +2 to include start and end explicitly
  # Radius values from 0 to r_max, repeated for the arc, and back to 0
  r_vals <- c(0, rep(r, n_points), 0)
  # Create data frame for the closed polygon
  data.frame(
    x = theta[c(1, 1:n_points, n_points + 2)],  # Start, arc points, end
    y = r_vals  # From 0 to r_max and back to 0
  )
}

day_poly   <- make_wedge(0, 12, r_max)
night_poly <- make_wedge(12, 24, r_max)

main_plot_with_legend <- ggplot(combined_'Your Abbrev Tag'_vector_data, aes(color = Condition)) +
  # Draw the day and night background ribbons
  geom_polygon(data = day_poly, aes(x = x, y = y),
               inherit.aes = FALSE, fill = "#FFFACD", alpha = 0.4) +
  geom_polygon(data = night_poly, aes(x = x, y = y),
               inherit.aes = FALSE, fill = "#E6E6FA", alpha = 0.4) +
  # Arrows are drawn based on their order in the arranged data frame
  geom_segment(
    aes(x = acrophase, y = 0, xend = acrophase, yend = amplitude),
    arrow = arrow(length = unit(0.3, "cm")),
    linewidth = 1.5
  ) +
  # Add the sun and moon symbols as annotations
  annotate("text", x = 6, y = max_amplitude * 1.4, label = "\u2600", size = 8) +
  annotate("text", x = 18, y = max_amplitude * 1.4, label = "\U0001F319", size = 8) +
  coord_polar(theta = "x", start = 0) +
  scale_x_continuous(limits = c(0, 24), breaks = seq(0,22, by = 2)) +
  scale_y_continuous(limits = c(0, max_amplitude * 1.5)) + 
  scale_color_manual(values = c("LD" = "black", "rLEN" = "red")) +
  labs(
    title = "'Your Measured Compound' Group Acrophase Comparison (LD vs. rLEN)",
    x = "Zeitgeber Time (ZT)", y = "Amplitude", color = "Condition"
  ) +
  theme_void() + # Start with a completely blank theme
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(color = "black"),      
    axis.title = element_text(color = "black"),
    axis.title.y = element_text(angle = 90, vjust = 0.5),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )

# --- 2. Create the separate amplitude legend plot ---

# Build the main plot to extract the actual y-axis (radial) breaks
plot_build_data <- ggplot_build(main_plot_with_legend)
radial_breaks <- plot_build_data$layout$panel_params[[1]]$r.major

# Filter out the break at 0, as we don't need a ring for it
legend_rings <- data.frame(r = radial_breaks[radial_breaks > 0])

# Determine the maximum radius for setting the y-limit of the legend plot
legend_max_val <- if (length(legend_rings$r) > 0) max(legend_rings$r) else 0

amplitude_legend_plot <- ggplot() +
  # Draw circles for each break value found in the main plot
  geom_circle(data = legend_rings, aes(x0 = 0, y0 = 0, r = r), color = "grey50") +
  # Add text labels for each circle
  geom_text(data = legend_rings, aes(x = 0, y = r, label = r), vjust = -0.5, size = 3) +
  theme_void() + 
  coord_fixed() +
  # Set ylim to ensure the largest ring and its text aren't cut off
  ylim(-legend_max_val, legend_max_val * 1.2)


# --- 3. Prepare the components for the final layout ---

main_plot_only <- main_plot_with_legend + theme(legend.position = "none")
condition_legend <- cowplot::get_legend(main_plot_with_legend)

# --- 4. Arrange the final figure in a three-column layout ---
final_plot <- grid.arrange(
  amplitude_legend_plot,
  main_plot_only,
  condition_legend,
  ncol = 3,
  widths = c(1.5, 5, 1.5)
)

# Set the working directory to the folder where you want to save PDFs
# Use ggsave() to save the plot as a high-quality PDF
rayleigh_dir <- here("Rayleigh Plots")
# Create the directory if it does not exist
if (!dir.exists(rayleigh_dir)) dir.create(rayleigh_dir)  
ggsave(
  filename = file.path(rayleigh_dir, "'Your Measured Compound'_Plot.pdf"),  
  plot = final_plot,
  width = 8,   # Width in inches
  height = 5,  # Height in inches
  device = cairo_pdf,
  # Add this line to specify the font
  family = "Segoe UI Symbol" 
)
```
